### **4. Linux用户与组管理**

#### 4.1 **用户和组的基本概念**

在Linux系统中，**用户**和**组**是文件系统权限管理的核心组成部分。所有的文件和目录都属于一个用户和一个用户组，而Linux通过设置不同的权限控制，来管理用户和组对文件的访问。

- **用户（User）**：每个用户在系统中都有一个唯一的用户名和用户ID（UID）。用户是系统中的个体，可以是管理员（root）或普通用户。
- **组（Group）**：一组用户可以组成一个组，每个组也有一个唯一的组名和组ID（GID）。组内的用户可以共享组的权限。

#### 4.2 **/etc/passwd 文件**

在Linux中，所有用户信息存储在 **`/etc/passwd`** 文件中。这个文件记录了每个用户的基本信息，如用户名、UID、GID、家目录路径等。

**/etc/passwd 文件格式**：

```
username:password:UID:GID:GECOS:home_directory:shell
```

- `username`：用户名。
- `password`：加密后的密码（通常存储在 `/etc/shadow` 文件中）。
- `UID`：用户ID，系统中的唯一标识符。
- `GID`：用户所属的主组ID。
- `GECOS`：用户的全名或描述信息。
- `home_directory`：用户的家目录路径。
- `shell`：用户的默认Shell（如 `/bin/bash`）。

**示例**：

```
nicholas:x:1001:1001:Nicholas DGB:/home/nicholas:/bin/bash
```

在这个例子中：

- 用户名是 `nicholas`。

- UID 和 GID 都是 `1001`。

- GECOS 字段是用户的全名：`Nicholas DGB`。

- 家目录是 `/home/nicholas`。

- 默认 Shell 是 `/bin/bash`。

  ------

  **解析：什么叫做用户的默认Shell?**

  - **Shell** 是用户与操作系统之间的交互界面，通常是命令行界面。在 Linux 系统中，Shell 是用户与内核通信的桥梁，用户输入的命令会通过 Shell 传递给内核执行，执行结果再反馈给用户。

  **指定用户的登录 Shell**：

  - **登录 Shell** 是指用户登录时使用的 Shell 程序。常见的登录 Shell 有 **Bash**、**Zsh**、**Fish** 等。

  - 在 `/etc/passwd` 文件中，每个用户的最后一个字段就是其登录时的默认 Shell。通过指定 Shell，可以为不同的用户配置不同的交互界面。例如：

    - 默认 Shell 是 `/bin/bash`：Bash 是最常用的 Linux Shell。

    - 可以通过 `usermod` 命令来更改用户的登录 Shell，如：

      ```
      sudo usermod -s /bin/zsh username
      ```

    这样，当用户 `username` 登录时，就会使用 Zsh 作为默认的 Shell。

  **为什么要指定登录 Shell？**

  - 不同的 Shell 提供不同的功能和交互体验。比如：
    - **Bash**：最常见，功能强大，兼容性好。
    - **Zsh**：比 Bash 更智能，支持自动补全、插件等功能。
    - **Fish**：易于使用，具有直观的语法和智能提示功能。

  通过为用户指定不同的 Shell，可以根据不同用户的需求选择合适的工作环境。

  ------

  

#### 4.3 **创建、删除和修改用户**

**创建用户：**
 使用 `useradd` 命令可以创建新用户。这个命令的基本语法是：

```
sudo useradd [options] username
```

常见选项：

- `-m`：创建用户的同时创建家目录。
- `-d`：指定用户的家目录。
- `-s`：指定用户的登录Shell。

例如，创建一个新用户 `john`，并为其指定家目录和Shell：

```
sudo useradd -m -d /home/john -s /bin/bash john
```

**删除用户：**
 使用 `userdel` 命令删除用户：

```
sudo userdel username
```

如果要删除用户及其家目录，可以加上 `-r` 选项：

```
sudo userdel -r john
```

**修改用户：**
 使用 `usermod` 命令来修改用户信息，例如修改用户的家目录或Shell：

```
sudo usermod -d /new/home/dir -s /bin/zsh john
```

#### 4.4 **创建、删除和修改组**

**创建组：**
 使用 `groupadd` 命令创建新组：

```
sudo groupadd groupname
```

**删除组：**
 使用 `groupdel` 命令删除组：

```
sudo groupdel groupname
```

**修改组：**
 使用 `groupmod` 命令修改组的信息。例如，修改组的名称：

```
sudo groupmod -n newgroup oldgroup
```

#### 4.5 **将用户添加到组**

用户可以属于多个组。通过将用户添加到组中，可以更灵活地管理文件和目录的权限。

**将用户添加到组：**
 使用 `usermod` 命令可以将用户添加到现有的组中：

```
sudo usermod -aG groupname username
```

- `-a`：追加到组。
- `-G`：指定要加入的组。

例如，将用户 `john` 添加到 `sudo` 组：

```
sudo usermod -aG sudo john
```

#### 4.6 **sudo与权限管理**

**sudo**（SuperUser Do）是 Linux 中非常重要的一个工具，它允许普通用户在不切换到 root 用户的情况下执行具有管理员权限的命令。它能够提供精细的权限控制。

**如何使用 sudo**：
 普通用户在执行需要管理员权限的命令时，可以使用 `sudo`，例如：

```
sudo apt update
```

这将会以管理员权限执行 `apt update`。

**配置 sudoers 文件：**
 `sudoers` 文件定义了哪些用户可以使用 `sudo`，以及他们能执行哪些命令。你可以使用 `visudo` 命令编辑该文件：

```
sudo visudo
```

在 `sudoers` 文件中，最常见的配置是给用户或组添加执行特定命令的权限。例如：

```
username ALL=(ALL) ALL
```

这表示 `username` 用户可以使用 `sudo` 执行所有命令。

为了给一个组赋予 sudo 权限，可以在 `sudoers` 文件中添加类似以下的行：

```
%sudo   ALL=(ALL) ALL
```

这表示 `sudo` 组中的所有用户都可以执行任意命令。

#### 4.7 **组与用户的安全管理思想**

在 Linux 中，**用户与组的管理**是基于最小权限原则（Principle of Least Privilege），即每个用户和组只能拥有执行其任务所必需的最小权限。这种方式可以有效避免滥用权限和安全漏洞。

**核心思想**：

- **用户的创建与管理**：每个用户都有唯一的身份（UID），通过用户ID来管理，用户只能访问自己有权限的资源。
- **组的使用**：通过将用户组织成组，可以方便地管理共享资源。组的权限通常是多个用户共享的，而不是每个用户单独管理。
- **sudo的使用**：通过给用户分配必要的`sudo`权限，管理员可以控制哪些命令可以由普通用户执行，从而避免给普通用户完全的 root 权限。

#### 4.8 **常见的权限管理实践**

- **专用用户与组**：为了安全性，系统管理员通常为服务和应用程序创建专用的用户和组。例如，Web 服务器通常运行在 `www-data` 用户和组下，而数据库服务运行在 `mysql` 用户和组下。
- **禁止使用 root 用户**：出于安全考虑，许多 Linux 系统禁用了 root 用户的直接登录，而是通过 `sudo` 提升权限。这样做可以减少恶意软件或攻击者通过 root 用户直接破坏系统的风险。
- **文件权限的细粒度控制**：通过用户和组的权限管理，可以为文件和目录设置非常精确的访问控制。例如，可以设置某个文件仅允许特定组的成员访问，而其他用户完全无法访问。

------

### 4.9 **一些疑问与解答**

#### 1. **最大权限是哪个？是 root 吗？**

是的，**root** 用户拥有最高权限，几乎可以控制和修改系统中的所有内容。root 用户有以下特权：

- 可以访问和修改任何文件，无论文件权限如何。
- 可以安装、删除软件包，修改系统配置。
- 可以管理其他用户和组的权限。

**root 是否是我们第一次进入 Shell 时的角色？**

- 不一定。如果你是刚安装的 Linux 系统，通常情况下，系统不会直接以 root 用户登录，而是以 **普通用户** 登录，只有在需要提升权限时才会使用 `sudo` 来临时获得 root 权限。
- 初始时，系统会创建一个普通用户（通常是安装时指定的用户），并赋予该用户使用 `sudo` 的权限。只有通过 `sudo` 命令或直接切换（如 `su`）才能获得 root 权限。

**root 能否被我们完全控制？**

- root 用户理论上没有权限限制，因此它能完全控制整个系统。不过，普通用户无法直接修改 root 用户权限，除非通过 `sudo` 或 `su` 获取权限。

**假设电脑是我的，那么初始情况下，我是 root 吗？**

- 不，初始情况下你应该是普通用户。即使你是该计算机的唯一用户，也通常会有一个普通用户角色，并且只有在需要时才能使用 root 权限（例如通过 `sudo` 或 `su`）。只有通过 sudo 或者登录为 root 才能获得最大权限。

#### **2.超级用户与管理员用户，Linux 中有哪些用户角色及权限？**

- **超级用户**：
   `root` 用户被称为**超级用户**，它有最高的权限，可以执行系统中的所有操作。**它的权限没有任何限制**，几乎可以访问和修改系统中的所有内容。
- **管理员用户**：
   在 Linux 中，**管理员用户** **通常是具有 `sudo` 权限的普通用户**。通过 `sudo`，他们可以临时获得 root 权限来执行系统管理任务。管理员用户并不一定是 `root`，**但他们拥有通过 `sudo` 提升到 root 的能力**。
- **普通用户**：
   普通用户通常只能访问和修改自己的文件和资源，他们不能修改系统文件，也不能进行一些系统管理操作。普通用户通常会被分配一个 UID 和一个主组 GID。可以通过 `sudo` 获取临时的管理权限。
- **特殊角色**：
  - **系统用户**：通常是为服务或进程创建的用户，如 `www-data`（Web 服务用户），`mysql`（数据库用户）。这些用户没有登录 Shell，通常只能运行与其服务相关的程序。
  - **组用户**：组是用户的集合，组的目的是便于管理多个用户的权限。一个用户可以属于多个组。每个用户至少有一个主组。
- **继承权限**：
   在 Linux 中，**用户创建时会指定一个主组，主组会赋予该用户一些默认权限**，但并没有真正的“继承”机制。例如，**当你创建一个新用户时，系统会将其加入到一个默认的主组中，主组的权限影响该用户**。但用户在加入其他组后，拥有其他组的权限，实际上是通过组管理来控制访问的。

#### **3.从哪里可以创建新用户？哪些角色能够创建组？普通用户能否创建组？**

- **创建用户**：通常只有具有超级用户权限的角色（如 root）能够创建用户。创建用户的命令是 `useradd`，但是普通用户无法直接执行该命令，除非被赋予 `sudo` 权限。
- **创建组**：创建组的命令是 `groupadd`，同样，只有具有管理员权限的用户（如 root 或被授权的普通用户）可以创建组。普通用户没有权限创建组。
- **登录系统时是否必须有角色？**
  - 是的，每个用户登录系统时都需要一个角色。这个角色是系统中唯一的身份标识。对于一个新用户，只有管理员（通常是 root）能够创建该用户并分配角色。
- **权限继承关系**：
  - 权限继承是指用户或组的权限可以基于父角色或组的权限进行继承。用户在创建时，**会有一个主组（主组通常和用户同名），该组的权限会影响到用户**。
  - 普通用户创建的用户不能继承管理员权限，只有通过 root 用户才能创建不同角色，并设置这些角色的权限。
- **初始状态下是不是只有 root？**
  - 初始安装时，root 用户会自动创建，但为了安全起见，Linux 系统通常会创建一个普通用户，该普通用户可以使用 `sudo` 提升权限来执行管理员任务。

#### **4.谁能使用 sudo，sudoers 文件是谁来管理的？**

- **谁能使用 `sudo`？**

  - 只有在 **sudoers 文件** 中被授权的用户才能使用 `sudo` 命令。普通用户默认是不能使用 `sudo` 的，只有在管理员（通常是 root）授权后，用户才能使用 `sudo` 来获得临时的 root 权限。

- **`sudoers` 文件管理者：**

  - `sudoers` 文件通常由 **root 用户** 管理。这个文件指定了哪些用户或用户组可以使用 `sudo`，以及他们能执行哪些命令。管理员可以编辑该文件来授权或限制某些用户的权限。
  - 编辑 `sudoers` 文件时，应该使用 `visudo` 命令，这个命令会在编辑过程中检查语法错误，避免配置文件错误导致的系统不可用。

  **示例**：
   在 `sudoers` 文件中，可以看到类似以下的配置：

  ```
  username ALL=(ALL) ALL
  ```

  这表示 `username` 用户可以使用 `sudo` 执行任何命令。

  另外，如果要允许某个用户组使用 `sudo`，可以在 `sudoers` 文件中添加类似下面的配置：

  ```
  %groupname ALL=(ALL) ALL
  ```

  这表示 `groupname` 组的所有成员都可以使用 `sudo` 执行任意命令。

#### 5. **如何才能直接登录为 root？**

- 直接登录为 `root` 用户的方法取决于系统的配置。在许多现代 Linux 系统中，为了安全起见，**默认情况下会禁用 `root` 用户的直接登录**。即使你知道 `root` 的密码，默认的配置也可能会阻止你通过控制台或 SSH 等方式直接登录为 `root`。

  **常见方法**：

  - **使用 `sudo` 切换到 root**：

    ```
    sudo -i
    ```

    这个命令会让你以 root 用户的身份打开一个新的 shell。

  - **启用 `root` 登录**：
     如果你想直接登录为 `root`，你需要确保 `root` 用户的密码已设置，并且允许 `root` 登录。你可以通过以下命令设置 `root` 密码：

    ```
    sudo passwd root
    ```

    然后，你可以尝试通过 `su` 或其他方法以 `root` 登录。

  **注意**：在很多发行版中，为了安全起见，直接登录为 `root` 是不推荐的。使用 `sudo` 进行授权管理更加安全。

#### 6. **`sudo` 和 `su` 的区别，使用 `sudo` 获取 root 权限是否意味着完全是 root？**

- **`sudo` 和 `su` 的区别**：

  - `sudo`（SuperUser Do）允许普通用户以 root 用户的身份执行某个命令，但该命令的执行权限是有限的，且仅在当前命令执行时有效。使用 `sudo` 时，通常会要求用户输入自己的密码。
  - `su`（Switch User）用于切换用户，默认情况下是切换到 root 用户。当你使用 `su` 时，系统会要求输入 `root` 的密码，然后你会进入一个 root shell，拥有 root 用户的所有权限。

  **`sudo` 获取 root 权限 vs root 用户**：

  - 使用 `sudo` 获取 root 权限时，你会获得 root 用户的权限执行特定的命令，但你并没有真正“切换”到 root 用户。你仍然是以你自己的身份执行命令，只是通过 `sudo` 提升了权限。
  - 当你通过 `su` 切换到 root 用户时，你的身份就变成了 root，所有的权限都完全属于 root 用户。

  **限制**：

  - 即使你通过 `sudo` 获取了 root 权限，也不代表你可以做任何事。管理员通过 `sudoers` 文件可以限制某些命令或操作的权限。例如，你可能只能执行某些命令，不能进行系统级的操作，具体取决于 `sudoers` 文件的配置。